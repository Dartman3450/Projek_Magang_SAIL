<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAIL â€“ Operational Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:       #f4f6f8;
      --surface:  #ffffff;
      --border:   #e4e8ed;
      --border2:  #cfd6de;
      --txt:      #1a202c;
      --txt2:     #4a5568;
      --txt3:     #a0aec0;
      --blue:     #2b7de9;
      --green:    #18a96a;
      --orange:   #e07b2a;
      --yellow:   #c99a0a;
      --purple:   #6f52d9;
      --red:      #dc3545;
      --sidebar:  230px;
      --radius:   12px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--txt);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: var(--sidebar);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
    }

    .logo-wrap {
      padding: 20px 18px 16px;
      border-bottom: 1px solid var(--border);
    }
    .logo-tag {
      font-family: 'DM Mono', monospace;
      font-size: 17px;
      font-weight: 500;
      color: var(--blue);
      letter-spacing: 3px;
    }
    .logo-sub {
      font-size: 10px;
      color: var(--txt3);
      letter-spacing: 1px;
      margin-top: 3px;
    }

    .nav { flex: 1; padding: 12px 10px; }
    .nav-section-label {
      font-size: 9px; letter-spacing: 1.5px; color: var(--txt3);
      text-transform: uppercase; padding: 12px 8px 5px; font-weight: 600;
    }
    .nav-item {
      display: flex; align-items: center; gap: 9px;
      padding: 8px 10px; border-radius: 8px; cursor: pointer;
      color: var(--txt2); font-size: 13px; font-weight: 500;
      transition: all .15s; position: relative;
    }
    .nav-item:hover { background: var(--bg); color: var(--txt); }
    .nav-item.active { background: #ebf2fd; color: var(--blue); }
    .nav-item.active::before {
      content: ''; position: absolute; left: 0; top: 6px; bottom: 6px;
      width: 3px; background: var(--blue); border-radius: 2px;
    }
    .nav-item .ico { font-size: 14px; width: 16px; text-align: center; flex-shrink: 0; }

    .nav-group { margin-bottom: 2px; }
    .nav-group-head {
      display: flex; align-items: center; gap: 9px;
      padding: 8px 10px; border-radius: 8px; cursor: pointer;
      color: var(--txt2); font-size: 13px; font-weight: 500; transition: all .15s;
    }
    .nav-group-head:hover { background: var(--bg); color: var(--txt); }
    .nav-group-head .ico { font-size: 14px; width: 16px; text-align: center; flex-shrink: 0; }
    .nav-group-head .arr { font-size: 9px; margin-left: auto; transition: transform .22s; color: var(--txt3); }
    .nav-group-head.open .arr { transform: rotate(180deg); }
    .nav-sub { display: none; padding-left: 26px; padding-bottom: 3px; }
    .nav-sub.show { display: block; }
    .nav-sub-item {
      padding: 6px 10px; font-size: 12px; color: var(--txt3);
      cursor: pointer; border-radius: 6px; transition: all .15s;
    }
    .nav-sub-item:hover { color: var(--blue); background: #ebf2fd; }

    .sidebar-footer {
      padding: 12px 10px; border-top: 1px solid var(--border);
    }
    .logout-btn {
      display: flex; align-items: center; gap: 9px;
      padding: 8px 10px; border-radius: 8px; cursor: pointer;
      color: var(--txt3); font-size: 13px; font-weight: 500; transition: all .15s;
    }
    .logout-btn:hover { background: #fdf2f2; color: var(--red); }

    /* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 13px 26px; border-bottom: 1px solid var(--border);
      background: var(--surface); flex-shrink: 0;
    }
    .topbar-left { display: flex; flex-direction: column; gap: 2px; }
    .topbar-page { font-size: 16px; font-weight: 600; color: var(--txt); }
    .topbar-crumb { font-size: 11px; color: var(--txt3); }
    .topbar-right { display: flex; align-items: center; gap: 12px; }

    /* ESP Status badge */
    .esp-badge {
      display: flex; align-items: center; gap: 7px;
      padding: 5px 13px; border-radius: 100px;
      font-size: 11px; font-weight: 600; letter-spacing: .4px;
      border: 1px solid; transition: all .4s;
    }
    .esp-badge.waiting  { background: #fef9ec; border-color: #f0d078; color: #9a7200; }
    .esp-badge.connected{ background: #edfaf4; border-color: #8edcba; color: #0e7a4a; }
    .esp-badge.error    { background: #fef2f2; border-color: #f0a0a0; color: #b91c1c; }
    .esp-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .esp-badge.waiting   .esp-dot { background: #d4a017; animation: espPulse 1.8s infinite; }
    .esp-badge.connected .esp-dot { background: var(--green); box-shadow: 0 0 5px var(--green); }
    .esp-badge.error     .esp-dot { background: var(--red); }
    @keyframes espPulse { 0%,100%{opacity:1} 50%{opacity:.25} }

    .clock-txt {
      font-family: 'DM Mono', monospace;
      font-size: 13px; color: var(--txt3);
    }

    .content {
      flex: 1; overflow-y: auto;
      padding: 22px 26px;
      background: var(--bg);
    }

    /* â”€â”€â”€ Sensor Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }

    /* â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 16px 14px;
      position: relative;
      overflow: hidden;
      transition: box-shadow .2s, border-color .2s;
    }
    .s-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.07); border-color: var(--border2); }
    .s-bar {
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--acc, var(--blue));
      border-radius: var(--radius) var(--radius) 0 0; opacity: .7;
    }

    /* waiting overlay per card */
    .esp-waiting-overlay {
      display: none;
      position: absolute; inset: 0;
      background: rgba(244,246,248,.88);
      border-radius: var(--radius);
      flex-direction: column;
      align-items: center; justify-content: center; gap: 7px;
      z-index: 5; backdrop-filter: blur(1px);
    }
    .esp-waiting-overlay.show { display: flex; }
    .esp-wait-icon { font-size: 20px; opacity: .45; }
    .esp-wait-txt  { font-size: 11px; font-weight: 600; color: var(--txt3); letter-spacing: .3px; }
    .esp-wait-sub  { font-size: 10px; color: var(--txt3); opacity: .65; }
    .dots::after   { content: ''; animation: dots 1.8s steps(4,end) infinite; }
    @keyframes dots { 0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} 100%{content:''} }

    .s-label {
      font-size: 10px; font-weight: 600; letter-spacing: 1.8px;
      color: var(--txt3); text-transform: uppercase; margin-bottom: 8px;
    }
    .s-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
    .s-num {
      font-family: 'DM Mono', monospace;
      font-size: 30px; font-weight: 500;
      color: var(--acc, var(--blue));
    }
    .s-unit { font-size: 11px; color: var(--txt3); margin-top: 3px; }
    .s-pill {
      display: inline-flex; align-items: center;
      font-size: 9px; font-weight: 600; letter-spacing: .8px;
      padding: 3px 9px; border-radius: 100px; margin-top: 7px; border: 1px solid;
    }
    .st-ok   { background: #edfaf4; color: #0e7a4a; border-color: #8edcba; }
    .st-warn { background: #fef9ec; color: #9a7200; border-color: #f0d078; }
    .st-crit { background: #fef2f2; color: #b91c1c; border-color: #f0a0a0; }
    .st-wait { background: var(--bg); color: var(--txt3); border-color: var(--border2); }

    .s-rows { display: flex; flex-direction: column; gap: 4px; }
    .irow {
      display: flex; justify-content: space-between; align-items: center;
      padding: 3px 0; border-bottom: 1px solid var(--border);
    }
    .irow:last-child { border: none; }
    .ik { font-size: 9px; color: var(--txt3); font-weight: 600; letter-spacing: .4px; }
    .iv { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--txt2); }

    /* â”€â”€â”€ TANK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.tank-wrap { display:flex; align-items:flex-end; gap:9px; height:128px; margin-top:4px; }
    .tank-col { display:flex; flex-direction:column; align-items:center; gap:4px; }
    .tank {
      width: 50px; height: 98px;
      border: 1.5px solid var(--border2); border-radius: 4px 4px 6px 6px;
      position: relative; overflow: hidden; background: var(--bg);
    }
    .tank-water {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: linear-gradient(180deg, #bfdffa, #3b9de8);
      transition: height 1.8s cubic-bezier(.34,1.2,.64,1);
    }
    .tank-water::after {
      content:''; position:absolute; top:-3px; left:0; right:0; height:6px;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
      animation:wsurf 3s ease-in-out infinite; border-radius:50%;
    }
    @keyframes wsurf{0%,100%{transform:scaleX(1) translateX(0)} 50%{transform:scaleX(1.05) translateX(3px)}}
    .bbl { position:absolute; border-radius:50%; background:rgba(255,255,255,.5); animation:brise linear infinite; }
    @keyframes brise{0%{bottom:0;opacity:.7}100%{bottom:100%;opacity:0}}
    .tank-pct { font-family:'DM Mono',monospace; font-size:9px; color:var(--txt3); }
    .tank-ruler { display:flex; flex-direction:column; justify-content:space-between; height:98px; padding:2px 0; }
    .tank-ruler span { font-family:'DM Mono',monospace; font-size:7px; color:var(--txt3); display:flex; align-items:center; gap:3px; }
    .tank-ruler span::after { content:''; width:5px; height:1px; background:var(--border2); }

    /* â”€â”€â”€ PIPE / FAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.pipe-wrap { display:flex; flex-direction:column; align-items:center; gap:10px; height:128px; justify-content:center; margin-top:4px; }
    .pipe-row { display:flex; align-items:center; width:100%; }
    .pipe-cap { width:10px; height:22px; border:1.5px solid var(--border2); background:var(--bg); }
    .pipe-cap.l{border-right:none;border-radius:4px 0 0 4px;}
    .pipe-cap.r{border-left:none;border-radius:0 4px 4px 0;}
    .pipe-seg{flex:1;height:22px;position:relative;overflow:hidden;border-top:1.5px solid var(--border2);border-bottom:1.5px solid var(--border2);background:#f0f8ff;}
    .fp{position:absolute;height:2px;border-radius:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);animation:fpm linear infinite;}
    @keyframes fpm{0%{left:-25%}100%{left:115%}}
    .fan-hub{width:42px;height:42px;border:1.5px solid var(--border2);border-radius:50%;background:var(--surface);display:grid;place-items:center;flex-shrink:0;}
    .fan-svg{animation:fspin linear 3s infinite;}
    @keyframes fspin{to{transform:rotate(360deg)}}
    .pipe-stats{display:flex;justify-content:space-between;width:100%;}
    .ps{text-align:center;}
    .psl{font-size:9px;color:var(--txt3);font-weight:600;}
    .psv{font-family:'DM Mono',monospace;font-size:11px;color:var(--green);}

    /* â”€â”€â”€ THERMOMETER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.thermo-wrap{display:flex;gap:10px;align-items:center;height:128px;margin-top:4px;}
    .thermo-col{display:flex;flex-direction:column;align-items:center;}
    .thermo-tube{width:16px;height:84px;border:1.5px solid var(--border2);border-bottom:none;border-radius:8px 8px 0 0;position:relative;overflow:hidden;background:var(--bg);}
    .thermo-merc{position:absolute;bottom:0;left:2px;right:2px;background:linear-gradient(0deg,#c0392b,var(--orange));border-radius:4px 4px 0 0;transition:height 1.5s ease;}
    .thermo-neck{width:7px;height:6px;border-left:1.5px solid var(--border2);border-right:1.5px solid var(--border2);align-self:center;background:var(--bg);}
    .thermo-bulb{width:24px;height:24px;border:1.5px solid var(--border2);border-radius:50%;background:radial-gradient(circle at 35% 35%,#fdba74,#c0392b);transition:background 1s;}
    .thermo-scale{display:flex;flex-direction:column;justify-content:space-between;height:84px;padding:2px 0;margin-left:3px;}
    .thermo-scale span{font-family:'DM Mono',monospace;font-size:7px;color:var(--txt3);display:flex;align-items:center;gap:3px;}
    .thermo-scale span::before{content:'';width:5px;height:1px;background:var(--border2);}

    /* â”€â”€â”€ GAUGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.hum-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;height:128px;justify-content:center;margin-top:4px;}
    .gauge-outer{position:relative;width:144px;height:78px;}
    .gauge-ct{position:absolute;bottom:0;left:50%;transform:translateX(-50%);text-align:center;}
    .g-num{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--yellow);}
    .g-unit{font-size:9px;color:var(--txt3);}
    .drops-row{display:flex;gap:5px;align-items:flex-end;height:20px;}
    .drp{width:9px;clip-path:polygon(50% 0%,100% 65%,80% 100%,20% 100%,0% 65%);transition:height .9s,background .9s,opacity .9s;}

    /* â”€â”€â”€ GAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.gas-wrap{display:flex;flex-direction:column;gap:9px;height:128px;justify-content:center;margin-top:4px;}
    .gas-icon-row{display:flex;align-items:center;gap:9px;}
    .gas-emoji{font-size:20px;animation:gfloat 2.5s ease-in-out infinite;}
    @keyframes gfloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    .gas-bars{flex:1;display:flex;flex-direction:column;gap:5px;}
    .gbrow{display:flex;align-items:center;gap:6px;}
    .gbl{font-size:9px;color:var(--txt3);width:26px;font-weight:600;}
    .gbt{flex:1;height:7px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
    .gbf{height:100%;border-radius:4px;transition:width 1.5s ease;}
    .gbv{font-family:'DM Mono',monospace;font-size:9px;width:30px;text-align:right;}
    .gas-ptcl{display:flex;justify-content:center;gap:5px;align-items:flex-end;height:20px;}
    .gp{width:4px;border-radius:3px;animation:gprs ease-in-out infinite;}
    @keyframes gprs{0%,100%{transform:scaleY(1);opacity:.3}50%{transform:scaleY(1.7);opacity:.85}}

    /* â”€â”€â”€ PATROLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-viz.patrol-wrap{display:flex;gap:10px;height:128px;align-items:center;margin-top:4px;}
    .pat-ring-outer{position:relative;width:76px;height:76px;flex-shrink:0;}
    .pat-ring-num{position:absolute;inset:0;display:grid;place-items:center;font-family:'DM Mono',monospace;font-size:18px;color:var(--blue);}
    .pat-list{flex:1;display:flex;flex-direction:column;gap:4px;overflow:hidden;}
    .pat-row{display:flex;justify-content:space-between;align-items:center;padding:4px 8px;background:var(--bg);border-radius:6px;border-left:2px solid var(--blue);}
    .pat-name{font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80px;color:var(--txt);}
    .pat-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue);}

    /* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tbl-section{margin-top:4px;}
    .iot-tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;}
    .iot-tab{padding:6px 15px;border-radius:7px;border:1px solid var(--border);background:var(--surface);color:var(--txt2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .18s;}
    .iot-tab.active{background:var(--blue);color:#fff;border-color:var(--blue);box-shadow:0 3px 10px rgba(43,125,233,.2);}
    .tbl-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:240px;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead th{position:sticky;top:0;padding:10px 13px;text-align:left;font-size:9px;font-weight:600;color:var(--txt3);background:var(--surface);border-bottom:1px solid var(--border);letter-spacing:1.5px;text-transform:uppercase;white-space:nowrap;}
    tbody tr{border-bottom:1px solid var(--border);transition:background .12s;}
    tbody tr:last-child{border:none;}
    tbody tr:hover{background:var(--bg);}
    td{padding:8px 13px;font-size:12px;white-space:nowrap;color:var(--txt);}
    .td-id{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue);background:#ebf2fd;padding:2px 7px;border-radius:4px;}
    .tbl-empty{padding:32px;text-align:center;color:var(--txt3);font-size:12px;}

    /* â”€â”€â”€ Placeholder pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:12px;color:var(--txt3);}
    .page-placeholder .ph-ico{font-size:40px;opacity:.4;}
    .page-placeholder h2{font-size:18px;color:var(--txt2);font-weight:500;}
    .page-placeholder p{font-size:12px;}

    ::-webkit-scrollbar{width:5px;height:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}
  </style>
</head>
<body>

<!-- â•â•â•â• SIDEBAR â•â•â•â• -->
<aside class="sidebar">
  <div class="logo-wrap">
    <div class="logo-tag">SAIL</div>
    <div class="logo-sub">Support Operational System</div>
  </div>
  <nav class="nav">
    <div class="nav-section-label">Menu Utama</div>
    <div class="nav-item active" onclick="loadPage('iot')"><span class="ico">ğŸ“¡</span> Dashboard IoT</div>

    <div class="nav-section-label">Project</div>
    <div class="nav-group">
      <div class="nav-group-head" onclick="toggleNav(this)"><span class="ico">ğŸ“‹</span><span>Project Activity</span><span class="arr">â–¾</span></div>
      <div class="nav-sub">
        <div class="nav-sub-item" onclick="loadPage('recent')">Recent Project</div>
        <div class="nav-sub-item" onclick="loadPage('completed')">Completed Project</div>
        <div class="nav-sub-item" onclick="loadPage('ongoing')">On Going Project</div>
      </div>
    </div>

    <div class="nav-section-label">Data</div>
    <div class="nav-group">
      <div class="nav-group-head" onclick="toggleNav(this)"><span class="ico">ğŸ—„ï¸</span><span>Data &amp; Information</span><span class="arr">â–¾</span></div>
      <div class="nav-sub">
        <div class="nav-sub-item" onclick="loadPage('production')">Data Entry Production</div>
        <div class="nav-sub-item" onclick="loadPage('utility')">Data Entry Utility</div>
        <div class="nav-sub-item" onclick="loadPage('laboratorium')">Data Entry Laboratorium</div>
        <div class="nav-sub-item" onclick="loadPage('limbah')">Data Entry Limbah</div>
      </div>
    </div>

    <div class="nav-item" onclick="loadPage('reporting')"><span class="ico">ğŸ“Š</span> Reporting</div>

    <div class="nav-section-label">Pengaturan</div>
    <div class="nav-group">
      <div class="nav-group-head" onclick="toggleNav(this)"><span class="ico">âš™ï¸</span><span>Setting</span><span class="arr">â–¾</span></div>
      <div class="nav-sub">
        <div class="nav-sub-item" onclick="loadPage('change-email')">Change Email</div>
        <div class="nav-sub-item" onclick="loadPage('change-password')">Change Password</div>
        <div class="nav-sub-item" onclick="loadPage('water-level-setting')">Change Water Level</div>
      </div>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="logout-btn" onclick="confirmLogout()"><span>ğŸšª</span> Logout</div>
  </div>
</aside>

<!-- â•â•â•â• MAIN â•â•â•â• -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-page" id="page-title">Dashboard IoT</div>
      <div class="topbar-crumb" id="page-crumb">SAIL / Dashboard / Monitor IoT</div>
    </div>
    <div class="topbar-right">
      <div class="esp-badge waiting" id="esp-badge">
        <div class="esp-dot"></div>
        <span id="esp-label">Menunggu koneksi ESP<span class="dots"></span></span>
      </div>
      <div class="clock-txt" id="clock">--:--:--</div>
    </div>
  </div>
  <div class="content" id="content"></div>
</div>

<script>
// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let espConnected = false;
let _activeTab   = 'water-level';

const API = {
  summary:    '/api/iot/dashboard/summary',
  waterLevel: '/api/iot/water-level',
  waterFlow:  '/api/iot/water-flow',
  lingkungan: '/api/iot/lingkungan',
  patroli:    '/api/iot/patroli',
};

// â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const set = (id, v) => { const el=$(id); if(el) el.textContent=v; };
const fmtT  = ts => ts ? new Date(ts).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : 'â€”';
const fmtDT = ts => ts ? new Date(ts).toLocaleString('id-ID') : 'â€”';
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));

// â•â• CLOCK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(() => set('clock', new Date().toLocaleTimeString('id-ID')), 1000);

// â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleNav(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('show');
}

function loadPage(page) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const map = {
    iot:['Dashboard IoT','SAIL / Dashboard / Monitor IoT'],
    recent:['Recent Project','SAIL / Project / Recent'],
    completed:['Completed Project','SAIL / Project / Completed'],
    ongoing:['On Going Project','SAIL / Project / On Going'],
    production:['Data Entry Production','SAIL / Data / Production'],
    utility:['Data Entry Utility','SAIL / Data / Utility'],
    laboratorium:['Data Entry Laboratorium','SAIL / Data / Laboratorium'],
    limbah:['Data Entry Limbah','SAIL / Data / Limbah'],
    reporting:['Reporting','SAIL / Reporting'],
    'change-email':['Change Email','SAIL / Setting / Email'],
    'change-password':['Change Password','SAIL / Setting / Password'],
    'water-level-setting':['Water Level Setting','SAIL / Setting / Water Level'],
  };
  const [title, crumb] = map[page] || [page,'SAIL'];
  set('page-title', title);
  set('page-crumb', crumb);
  const content = $('content');
  if (page === 'iot') {
    renderIoT(content);
  } else {
    content.innerHTML = `
      <div class="page-placeholder">
        <div class="ph-ico">ğŸš§</div>
        <h2>${title}</h2>
        <p>Halaman ini sedang dalam pengembangan.</p>
      </div>`;
  }
}

// â•â• ESP STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setEspStatus(state) {
  const badge = $('esp-badge');
  const label = $('esp-label');
  badge.className = 'esp-badge ' + state;
  if (state === 'connected') {
    label.innerHTML = 'ESP Terhubung';
  } else if (state === 'error') {
    label.innerHTML = 'Koneksi Gagal';
  } else {
    label.innerHTML = 'Menunggu koneksi ESP<span class="dots"></span>';
  }
}

function showOverlays(show) {
  ['wl','wf','suhu','kel','gas','pat'].forEach(k => {
    const ov = $('ov-'+k);
    if (ov) ov.classList.toggle('show', show);
  });
}

// â•â• IOT RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIoT(content) {
  content.innerHTML = getIoTHTML();
  initWidgets();
  fetchSummary();
  if (window._poll) clearInterval(window._poll);
  window._poll = setInterval(() => {
    if (!$('wl-val')) { clearInterval(window._poll); return; }
    fetchSummary();
    if (espConnected) loadTable(_activeTab);
  }, 30000);
}

function getIoTHTML() {
  const ov = `
    <div class="esp-waiting-overlay show" id="ov-ID">
      <div class="esp-wait-icon">ğŸ”Œ</div>
      <div class="esp-wait-txt">Menunggu ESP<span class="dots"></span></div>
      <div class="esp-wait-sub">Belum ada data masuk</div>
    </div>`;

  return `
  <div class="sensor-grid">

    <!-- TANGKI AIR -->
    <div class="s-card" style="--acc:var(--blue)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-wl')}
      <div class="s-label">Tinggi Air</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="wl-val">â€”</div>
          <div class="s-unit">cm</div>
          <div class="s-pill st-wait" id="wl-status">â€”</div>
        </div>
      </div>
      <div class="s-viz tank-wrap">
        <div class="tank-col">
          <div class="tank">
            <div class="tank-water" id="tank-water" style="height:0%">
              <div class="bbl" style="width:4px;height:4px;left:22%;animation-duration:2.8s"></div>
              <div class="bbl" style="width:3px;height:3px;left:58%;animation-duration:3.2s;animation-delay:1s"></div>
            </div>
          </div>
          <div class="tank-pct" id="tank-pct">â€”</div>
        </div>
        <div class="tank-ruler"><span>MAX</span><span>75</span><span>50</span><span>25</span><span>0</span></div>
        <div class="s-rows">
          <div class="irow"><span class="ik">LEVEL</span><span class="iv" id="wl-level">â€”</span></div>
          <div class="irow"><span class="ik">PERSEN</span><span class="iv" id="wl-pct2">â€”</span></div>
          <div class="irow"><span class="ik">UPDATE</span><span class="iv" id="wl-time">â€”</span></div>
        </div>
      </div>
    </div>

    <!-- FLOW AIR -->
    <div class="s-card" style="--acc:var(--green)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-wf')}
      <div class="s-label">Flow Air</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="wf-val">â€”</div>
          <div class="s-unit">L/min</div>
          <div class="s-pill st-wait" id="wf-status">â€”</div>
        </div>
      </div>
      <div class="s-viz pipe-wrap">
        <div class="pipe-row">
          <div class="pipe-cap l"></div>
          <div class="pipe-seg"><div id="pfl"></div></div>
          <div class="fan-hub">
            <svg class="fan-svg" id="fan-svg" width="32" height="32" viewBox="0 0 40 40">
              <g transform="translate(20,20)">
                <ellipse rx="3" ry="7" transform="rotate(0)"   fill="#18a96a" opacity=".9"/>
                <ellipse rx="3" ry="7" transform="rotate(60)"  fill="#18a96a" opacity=".6"/>
                <ellipse rx="3" ry="7" transform="rotate(120)" fill="#18a96a" opacity=".4"/>
                <ellipse rx="3" ry="7" transform="rotate(180)" fill="#18a96a" opacity=".9"/>
                <ellipse rx="3" ry="7" transform="rotate(240)" fill="#18a96a" opacity=".6"/>
                <ellipse rx="3" ry="7" transform="rotate(300)" fill="#18a96a" opacity=".4"/>
                <circle r="4" fill="white" stroke="#18a96a" stroke-width="1.5"/>
                <circle r="1.5" fill="#18a96a"/>
              </g>
            </svg>
          </div>
          <div class="pipe-seg"><div id="pfr"></div></div>
          <div class="pipe-cap r"></div>
        </div>
        <div class="pipe-stats">
          <div class="ps"><div class="psl">KECEPATAN</div><div class="psv" id="wf-rpm">â€”</div></div>
          <div class="ps"><div class="psl">VOLUME</div><div class="psv" id="wf-vol">â€”</div></div>
          <div class="ps"><div class="psl">UPDATE</div><div class="psv" style="color:var(--txt3)" id="wf-time">â€”</div></div>
        </div>
      </div>
    </div>

    <!-- SUHU -->
    <div class="s-card" style="--acc:var(--orange)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-suhu')}
      <div class="s-label">Suhu</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="suhu-val">â€”</div>
          <div class="s-unit">Â°C</div>
          <div class="s-pill st-wait" id="suhu-status">â€”</div>
        </div>
      </div>
      <div class="s-viz thermo-wrap">
        <div class="thermo-col">
          <div class="thermo-tube"><div class="thermo-merc" id="thermo-merc" style="height:0%"></div></div>
          <div class="thermo-neck"></div>
          <div class="thermo-bulb" id="thermo-bulb"></div>
        </div>
        <div class="thermo-scale"><span>50Â°</span><span>40Â°</span><span>30Â°</span><span>20Â°</span><span>10Â°</span><span>0Â°</span></div>
        <div class="s-rows">
          <div class="irow"><span class="ik">SUHU</span><span class="iv" id="suhu-v2">â€”</span></div>
          <div class="irow"><span class="ik">KONDISI</span><span class="iv" id="suhu-cond">â€”</span></div>
          <div class="irow"><span class="ik">UPDATE</span><span class="iv" id="suhu-time">â€”</span></div>
        </div>
      </div>
    </div>

    <!-- KELEMBAPAN -->
    <div class="s-card" style="--acc:var(--yellow)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-kel')}
      <div class="s-label">Kelembapan</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="kel-val">â€”</div>
          <div class="s-unit">%RH</div>
          <div class="s-pill st-wait" id="kel-status">â€”</div>
        </div>
      </div>
      <div class="s-viz hum-wrap">
        <div class="gauge-outer">
          <svg width="144" height="78" viewBox="0 0 156 86" style="overflow:visible">
            <defs>
              <linearGradient id="gGrd" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%"   stop-color="#2b7de9"/>
                <stop offset="50%"  stop-color="#c99a0a"/>
                <stop offset="100%" stop-color="#dc3545"/>
              </linearGradient>
            </defs>
            <path d="M13 83 A65 65 0 0 1 143 83" stroke="#e4e8ed" stroke-width="11" fill="none" stroke-linecap="round"/>
            <path id="g-arc" d="M13 83 A65 65 0 0 1 143 83" stroke="url(#gGrd)" stroke-width="11" fill="none" stroke-linecap="round"
              stroke-dasharray="204" stroke-dashoffset="204" style="transition:stroke-dashoffset 1.6s ease"/>
            <text x="7"   y="84" font-family="DM Mono,monospace" font-size="8" fill="#a0aec0">0</text>
            <text x="70"  y="16" font-family="DM Mono,monospace" font-size="8" fill="#a0aec0">50</text>
            <text x="138" y="84" font-family="DM Mono,monospace" font-size="8" fill="#a0aec0">100</text>
            <g id="g-needle" transform="rotate(-90,78,83)">
              <line x1="78" y1="83" x2="78" y2="24" stroke="#c99a0a" stroke-width="2" stroke-linecap="round"/>
              <circle cx="78" cy="83" r="4.5" fill="#c99a0a" stroke="white" stroke-width="2"/>
            </g>
          </svg>
          <div class="gauge-ct"><div class="g-num" id="g-num">â€”</div><div class="g-unit">%RH</div></div>
        </div>
        <div class="drops-row" id="drops-row"></div>
      </div>
    </div>

    <!-- GAS -->
    <div class="s-card" style="--acc:var(--purple)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-gas')}
      <div class="s-label">Kadar Gas</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="gas-val">â€”</div>
          <div class="s-unit">ppm</div>
          <div class="s-pill st-wait" id="gas-status">â€”</div>
        </div>
      </div>
      <div class="s-viz gas-wrap">
        <div class="gas-icon-row">
          <div class="gas-emoji">â˜ï¸</div>
          <div class="gas-bars">
            <div class="gbrow">
              <span class="gbl">NILAI</span>
              <div class="gbt"><div class="gbf" id="gbar-main" style="width:0%;background:linear-gradient(90deg,#18a96a,#6f52d9)"></div></div>
              <span class="gbv" id="gas-pct-lbl" style="color:var(--purple)">â€”</span>
            </div>
            <div class="gbrow">
              <span class="gbl" style="color:var(--green)">AMAN</span>
              <div class="gbt"><div class="gbf" style="width:50%;background:linear-gradient(90deg,rgba(24,169,106,.55),rgba(24,169,106,.1))"></div></div>
              <span class="gbv" style="color:var(--green)">300</span>
            </div>
            <div class="gbrow">
              <span class="gbl" style="color:var(--red)">MAX</span>
              <div class="gbt"><div class="gbf" style="width:100%;background:linear-gradient(90deg,rgba(220,53,69,.55),rgba(220,53,69,.1))"></div></div>
              <span class="gbv" style="color:var(--red)">600</span>
            </div>
          </div>
        </div>
        <div class="gas-ptcl" id="gas-ptcl"></div>
      </div>
    </div>

    <!-- PATROLI -->
    <div class="s-card" style="--acc:var(--blue)">
      <div class="s-bar"></div>
      ${ov.replace('ov-ID','ov-pat')}
      <div class="s-label">Laporan Patroli</div>
      <div class="s-header">
        <div>
          <div class="s-num" id="pat-total">â€”</div>
          <div class="s-unit">total laporan</div>
        </div>
      </div>
      <div class="s-viz patrol-wrap">
        <div class="pat-ring-outer">
          <svg viewBox="0 0 88 88" width="76" height="76">
            <defs>
              <linearGradient id="rGrd" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%"   stop-color="#2b7de9"/>
                <stop offset="100%" stop-color="#18a96a"/>
              </linearGradient>
            </defs>
            <circle cx="44" cy="44" r="35" stroke="#e4e8ed" stroke-width="7" fill="none"/>
            <circle id="pat-ring" cx="44" cy="44" r="35"
              stroke="url(#rGrd)" stroke-width="7" fill="none"
              stroke-dasharray="220" stroke-dashoffset="220"
              transform="rotate(-90,44,44)"
              style="transition:stroke-dashoffset 1.6s ease;stroke-linecap:round"/>
          </svg>
          <div class="pat-ring-num" id="pat-ring-num">â€”</div>
        </div>
        <div class="pat-list" id="patrol-list">
          <div style="font-size:11px;color:var(--txt3)">â€”</div>
        </div>
      </div>
    </div>

  </div>

  <!-- TABLE -->
  <div class="tbl-section">
    <div class="iot-tabs">
      <button class="iot-tab active" onclick="swTab('water-level',this)">Water Level</button>
      <button class="iot-tab" onclick="swTab('water-flow',this)">Water Flow</button>
      <button class="iot-tab" onclick="swTab('lingkungan',this)">Lingkungan</button>
      <button class="iot-tab" onclick="swTab('patroli',this)">Patroli</button>
    </div>
    <div class="tbl-wrap" id="tbl-cont">
      <div class="tbl-empty">Menunggu koneksi ESPâ€¦</div>
    </div>
  </div>`;
}

// â•â• INIT WIDGETS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initWidgets() {
  mkPipe('pfl',6); mkPipe('pfr',6);
  const dr=$('drops-row');
  if(dr) for(let i=0;i<7;i++){
    const d=document.createElement('div'); d.className='drp'; d.id='drp-'+i;
    d.style.cssText='height:6px;background:#e4e8ed;opacity:.3';
    dr.appendChild(d);
  }
  const gp=$('gas-ptcl');
  const gc=['#6f52d9','#a78bfa','#5b3fc9','#c4b5fd','#4c2ec4'];
  if(gp) for(let i=0;i<10;i++){
    const p=document.createElement('div'); p.className='gp';
    p.style.cssText=`background:${gc[i%5]};height:${8+Math.random()*14}px;animation-duration:${.6+Math.random()*.9}s;animation-delay:${Math.random()*.8}s`;
    gp.appendChild(p);
  }
}

function mkPipe(id,n){
  const c=$(id); if(!c) return;
  for(let i=0;i<n;i++){
    const p=document.createElement('div'); p.className='fp';
    p.style.cssText=`top:${7+Math.random()*6}px;height:${2+Math.random()*2}px;animation-duration:${.8+Math.random()*.9}s;animation-delay:${Math.random()*1.5}s;opacity:${.45+Math.random()*.4}`;
    c.appendChild(p);
  }
}

// â•â• FETCH DATA (REAL API) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchSummary() {
  try {
    const res = await fetch(API.summary);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    if (!j.success) throw new Error(j.message || 'error');

    espConnected = true;
    setEspStatus('connected');
    showOverlays(false);

    const d = j.data;
    applyWL(d.water_level);
    applyWF(d.water_flow);
    applyEnv(d.lingkungan);
    applyPatroli(d.total_patroli);
    loadTable(_activeTab);

  } catch(e) {
    console.warn('ESP tidak terhubung:', e.message);
    espConnected = false;
    setEspStatus('waiting');
    showOverlays(true);
    $('tbl-cont').innerHTML = '<div class="tbl-empty">Menunggu koneksi ESPâ€¦</div>';
  }
}

function showOverlays(show) {
  ['wl','wf','suhu','kel','gas','pat'].forEach(k=>{
    const ov=$('ov-'+k); if(ov) ov.classList.toggle('show', show);
  });
}

// â”€â”€ Apply data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyWL(wl) {
  if(!wl) return;
  const v = +(wl.tinggi_air ?? wl.water_level ?? wl.level ?? 0);
  const pct = clamp(Math.round(v/300*100),0,100);
  set('wl-val', v); set('wl-level', v+' cm');
  set('wl-pct2', pct+'%'); set('wl-time', fmtT(wl.created_at));
  set('tank-pct', pct+'%');
  const tw=$('tank-water'); if(tw) tw.style.height=pct+'%';
  pill('wl-status', v, 200, 250);
}

function applyWF(wf) {
  if(!wf) return;
  const v = +(wf.flow_rate ?? wf.water_flow ?? wf.flow ?? 0);
  set('wf-val', v);
  set('wf-rpm', Math.round(v*8)+' rpm');
  set('wf-vol', (wf.volume ?? 'â€”')+' L');
  set('wf-time', fmtT(wf.created_at));
  const fan=$('fan-svg');
  if(fan) fan.style.animationDuration = v>0 ? Math.max(.2,5/v)+'s' : '20s';
  document.querySelectorAll('.fp').forEach(p=>{
    p.style.animationPlayState = v>0?'running':'paused';
    p.style.animationDuration  = v>0?(1.2/Math.max(v,.5))+'s':'2s';
  });
  pill('wf-status', v, 80, 120);
}

function applyEnv(env) {
  if(!env) return;
  const suhu = +(env.suhu ?? env.temperature ?? 0);
  const lemb = +(env.kelembapan ?? env.humidity ?? 0);
  const gas  = +(env.gas ?? env.gas_value ?? env.ppm ?? 0);

  // suhu
  set('suhu-val', suhu); set('suhu-v2', suhu+'Â°C'); set('suhu-time', fmtT(env.created_at));
  const merc=$('thermo-merc'); if(merc) merc.style.height=clamp(suhu/50*100,0,100)+'%';
  let cond='NORMAL', bb='radial-gradient(circle at 35% 35%,#93c5fd,#1d4ed8)';
  if(suhu>=38){cond='SANGAT PANAS';bb='radial-gradient(circle at 35% 35%,#fca5a5,#b91c1c)';}
  else if(suhu>=35){cond='PANAS';bb='radial-gradient(circle at 35% 35%,#fdba74,#c2410c)';}
  else if(suhu>=30){cond='HANGAT';bb='radial-gradient(circle at 35% 35%,#fed7aa,#ea580c)';}
  set('suhu-cond', cond);
  const bulb=$('thermo-bulb'); if(bulb) bulb.style.background=bb;
  pill('suhu-status', suhu, 35, 40);

  // kelembapan
  set('kel-val', lemb); set('g-num', lemb);
  const arc=$('g-arc'); if(arc) arc.style.strokeDashoffset=204-(lemb/100)*204;
  const ndl=$('g-needle'); if(ndl) ndl.setAttribute('transform',`rotate(${-90+(lemb/100)*180},78,83)`);
  for(let i=0;i<7;i++){
    const drp=$('drp-'+i); if(!drp) continue;
    const active=(lemb/100*7)>i;
    drp.style.height=(active?11+i*2:6)+'px';
    drp.style.opacity=active?'.8':'.2';
    drp.style.background=lemb>90?'var(--red)':lemb>75?'var(--yellow)':'var(--blue)';
  }
  pill('kel-status', lemb, 80, 95);

  // gas
  const maxG=600, gPct=clamp(Math.round(gas/maxG*100),0,100);
  set('gas-val', gas); set('gas-pct-lbl', gPct+'%');
  const gbar=$('gbar-main');
  if(gbar){
    gbar.style.width=gPct+'%';
    gbar.style.background=gas>=500?'linear-gradient(90deg,#e07b2a,#dc3545)':gas>=300?'linear-gradient(90deg,#c99a0a,#e07b2a)':'linear-gradient(90deg,#18a96a,#6f52d9)';
  }
  document.querySelectorAll('.gp').forEach((p,i)=>{
    p.style.animationDuration=(Math.max(.3,1.4-gas/600)+(i%3)*.12)+'s';
  });
  pill('gas-status', gas, 300, 500);
}

function applyPatroli(total) {
  const tot = parseInt(total)||0;
  set('pat-total', tot); set('pat-ring-num', tot);
  const ring=$('pat-ring');
  if(ring) ring.style.strokeDashoffset=220-(tot/Math.max(tot,50))*220;
}

function pill(id, v, warnAt, critAt) {
  const el=$(id); if(!el) return;
  if(v==null){el.textContent='â€”';el.className='s-pill st-wait';return;}
  let c='st-ok',t='NORMAL';
  if(critAt!==undefined&&v>=critAt){c='st-crit';t='BAHAYA';}
  else if(warnAt!==undefined&&v>=warnAt){c='st-warn';t='PERHATIAN';}
  el.textContent=t; el.className='s-pill '+c;
}

// â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tabApi = {
  'water-level': API.waterLevel,
  'water-flow':  API.waterFlow,
  'lingkungan':  API.lingkungan,
  'patroli':     API.patroli,
};

function swTab(tab, el) {
  _activeTab = tab;
  document.querySelectorAll('.iot-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  loadTable(tab);
}

async function loadTable(tab) {
  const c=$('tbl-cont'); if(!c) return;
  if(!espConnected){c.innerHTML='<div class="tbl-empty">Menunggu koneksi ESPâ€¦</div>';return;}
  c.innerHTML='<div class="tbl-empty" style="color:var(--txt3)">Memuat dataâ€¦</div>';
  try {
    const j = await (await fetch(tabApi[tab])).json();
    if(!j.success||!j.data.length){c.innerHTML='<div class="tbl-empty">Belum ada data tersedia</div>';return;}
    const rows=j.data, keys=Object.keys(rows[0]);
    let h=`<table><thead><tr>${keys.map(k=>`<th>${k.replace(/_/g,' ')}</th>`).join('')}</tr></thead><tbody>`;
    rows.forEach(r=>{
      h+=`<tr>${keys.map(k=>{
        const v=r[k];
        if(k==='id') return `<td><span class="td-id">#${v}</span></td>`;
        if(k.includes('_at')) return `<td style="color:var(--txt3);font-size:11px">${fmtDT(v)}</td>`;
        return `<td>${v??'â€”'}</td>`;
      }).join('')}</tr>`;
    });
    c.innerHTML=h+'</tbody></table>';
  } catch(e){
    c.innerHTML=`<div class="tbl-empty">Gagal memuat data</div>`;
  }
}

// â•â• LOGOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmLogout() {
  if(confirm('Yakin ingin logout?')){
    localStorage.removeItem('isLoggedin');
    window.location.href='../Homepage/Homepage.html';
  }
}

// â•â• BOOT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadPage('iot');
</script>
</body>
</html>